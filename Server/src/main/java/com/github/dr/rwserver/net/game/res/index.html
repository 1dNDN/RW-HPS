<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>铁锈战争控制台</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="table.js"></script>
    <script src="mican.min.js"></script>
    <style>
        *{
            margin: 0 auto;
        }
        .btn{
            background-color: rgba(175, 248, 219, 0.53);
            transition: 1s linear;
            box-shadow:1px 3px 10px 2px rgb(144 144 144 / 29%);
            height: 50px;
            line-height: 50px;
            font-size: 20px;
            color: #250a57;
            padding: 5px 8px;
            user-select: none;
        }
        .des{
            background-color: rgb(248, 175, 247);
            transition: 1s linear;
            box-shadow:1px 3px 10px 2px rgb(144 144 144 / 29%);

            color: #250a57;
            padding: 5px 8px;
            user-select: none;
        }
        .para{
            background-color: rgb(238, 87, 147);
            transition: 1s linear;
            box-shadow:1px 3px 10px 2px rgb(144 144 144 / 29%);
            color: #250a57;
            padding: 5px 8px;
            user-select: none;
        }
        .btn:hover{
            background-color: #7fffc8;
            transition: 1s linear;
            cursor: pointer;
            user-select: none;
        }
        .des:hover{
            background-color: #e735a9;
            transition: 1s linear;
            cursor: pointer;
            user-select: none;
        }
        .bord-with{
            width: 810px;
        }
        .board{

            color: #dbe6f8;
            padding: 10px;
        }
        #cmTab{
            width: 600px;
            display: inline-block;
            border-left: 3px solid #ababab;
            background-color: #f0f8ffaa;
        }
        .cmdEl{
            margin: 0 3px;
            display: inline-block;
            height: 40px;
            line-height: 40px;
            font-size: 15px;
        }
        .block-cover div{
            background-color:#333333aa;
            transition: 1s linear;
        }
           input:focus{
               outline: 0;
               border: 1px solid #c5ff00;
               box-shadow: 2px 2px 5px 4px #aaaaaa1a;
               transition: 0.5s linear;
           }
           input {
               height: 19px;
               /*很关键：将默认的select选择框样式清除*/
               appearance: none;
               -moz-appearance: none;
               -webkit-appearance: none;
               padding: 5px 8px;
               box-shadow: 2px 2px 5px 4px #5555551a;
               border: 1px solid #9cc318;
               border-radius: 0;
               transition: 0.5s linear;
               color: #494949;
           }
           .darken{
               background-color: #5555552a;
               transition: 0.5s linear;
           }
           .darken:hover{
               background-color: #aaaaaa2a;
               transition: 0.5s linear;
           }
           /*卡片*/
        :root{
            --mc-bg-z:#eee;
            --mc-bg-ka:#333;
            --mc-bg-hong: rgb(90, 60, 60);
            --mc-bg-lv: rgb(89, 212, 144);
            --mc-bg-hui: rgb(151, 151, 151);
            --mc-bg-liang: rgb(121, 98, 98);
        }
        *{
            margin: 0 auto;
        }
        .mc-ka-z{
            width:100%;
            box-shadow: 2px 2px 10px 2px #aac9b942;
            margin: 20px;
            float: left;
            /* border-radius: 4px; */
        }
        .mc-ka-z:hover{
            background-color: rgb(184, 166, 184);
        }
        .mc-ka-st{
            width: 180px;
            margin: 10px 15px;
            box-shadow: 2px 2px 10px 2px #787878a8;
            background-color: var(--mc-bg-ka);
            float: left;
            border-radius: 5px;
            transition: 0.5s;
        }
        .mc-ka-st:hover{
            cursor: pointer;
            background-color: var(--mc-bg-liang);
        }
        .mc-ka-sx{
            height: 18px;
            font-size: 16px;
            line-height: 18px;
            color: aliceblue;
            margin:8px 5px;
            padding:0 5px;
            word-wrap:break-word;
            word-break:normal;
            display: inline-block;border-radius: 3px;
            background-color: var(--mc-bg-hong);
        }
        .mc-dh{
            transition: 0.5s;
        }
        .mc-ka-tou{
            background-color: rgba(220, 236, 230, 0.53);
            padding: 5px 8px;
        }
        .mc-ka-tou span{
            background-color: rgba(53, 212, 149, 0.53);
            transition: 0.5s;
            box-shadow: 1px 3px 10px 2px rgb(144 144 144 / 29%);
            height: 50px;
            line-height: 50px;
            font-size: 20px;
            color: #250a57;
            padding: 5px 8px;
            user-select: none;
        }
        .mc-ka-tou span:hover{
            background-color: aquamarine;
        }
    </style>
</head>
<body background="https://i.loli.net/2021/07/23/lHmwVns1AQxqXOC.jpg">
<div class="bord-with">
    <div style="width: 200px;display: inline-block">
        <form id="form" class="bord-with">
            <input id="a" name="a" style="height: 27px" type="password"/>
            <br>
            <span class="btn" onclick="connect()">连接</span>
            <span class="btn" onclick="setCan()">参数设置</span>
            <br>
            <input id="b" name="b" style="height: 27px"/>
        </form>
        <span class="btn" onclick="doCmd()">发送命令</span>
        <span class="btn" onclick="clearBoard()">清除日志</span>
        <div id="backInfo"></div>
    </div>
    <span style="background-color: #7f7f7f;width: 20px"></span>
    <div id="cmTab">
    </div>
</div>
<div id="playStat" style="background-color: #dbe6f840;border-top: 5px solid #6c5c5c8c;">
    <div style="height: 50px;width: 550px">
        <span class="btn" style="font-size: 16px;"  onclick="sendServerMsg()">发送服务器消息</span>
        <input id="pMsg" style="display: block;float: left;margin: 10px;"/>
        <span id="playTime" class="des" style="height: 30px;"></span>
    </div>
    <div style="height: 10px"></div>
    <div id="zu" style="margin: 0 auto;width: 936px;">
    <div style="height: 30px"></div>
</div>
<div id="boardWra" style="background-color: #6495eded">
    <div class="board" id="board">
        <p>服务器信息：</p>
    </div>
</div>
<script>
    let a=axios;
    styleAttach();
    let pick=new Object();
    pick.s=false;
    pick.for='';


    let isCon=false;
    let backInfo = document.getElementById("backInfo");
    let board = document.getElementById("board");
    let playStartTime=new Date().getTime();
    let isGameStart=[false];
    let playTimeDom=document.getElementById("playTime");
    function boardGoing(str){
        let el = document.createElement("p");
        el.innerText=str;
        el.style.backgroundColor=colorWalkS(266,50,0.3,40,90)
        board.prepend(el);
    }
    function clearBoard(){
        board.innerText="..."
    }
    let ws;
    function connect(){
        if(ws&&ws.isConnected) {
            boardGoing("已连接")
            return;
        }
        if(document.getElementById("a").value.length<1)  {
            backInfo.innerText="请输入密码接入"
            return
        }
        ws= new WebSocket("ws://"+location.host+"/ws")
        ws.onopen=function (){
            msgSend("-rc")
            boardGoing("已连接")
            setTimeout(()=>msgSend("-ts"),1000)
            isCon=true
        }
        ws.onmessage=function (e){
            if(e.data.indexOf("-c ")>-1){
              cmdList(e.data)
            }else if(e.data.indexOf("-ts")==0){
                let playStat = document.getElementById("zu");
                playStat.innerText=""
                let dm=e.data.substr(3);
                let data = JSON.parse(dm);
                toCard(data,playStat,(p,i,e)=>{
                    if(i==6) p.parentElement.style.setProperty("--mc-bg-ka",e=="断开"?"rgb(151, 151, 151)":"rgb(89, 212, 144)")
                    p.style.setProperty("--mc-bg-hong",colorWalk(8947848))
                },1)
            }else if(e.data.startsWith("-gf ")) initServerCan(e.data);
            else boardGoing(e.data)
        }
        ws.onclose=function (){
            boardGoing("已断开")
            isCon=false
        }
    }
    function oneCard(data,hd,ski,ys){
        let ka=g("div")
        ka.classList.add("mc-ka-st","mc-dh")
        data.forEach((e,i) => {
            if(ski&&i==ski){
                ka.id=e;
            }else{
                let p=g("p")
                p.classList.add("mc-ka-sx")
                p.innerText=e
                if(hd) p.title=hd[i]
                ka.append(p)
                if(ys) ys(p,i,e)
            }

        });
        return ka;
    }
    let timeL=[]
    let tesss='-ts[["玩家昵称","uuid","位置","延迟","队伍","管理","游戏状态","组","平均延迟","ping/次","连接地址"],{"head":["1","战役室","1628248856819"],"body":[["单于","AD470BB9430431B04C73E9C9D3714FD24CBB73000C8038FE2163A6AFF62029A4","4","27","0","true","比赛中","1","29.7","30","112.14.105.214:5123"]]},{"head":["1","战役室","1628248856819"],"body":[["世界核平","48ADFFD10A469EFD2BCE7623587E9FFE9DD31E9D09E925EAA22217B1418636A1","1","48","1","false","比赛中","1","52.57895","19","43.227.139.179:5123"]]},{"head":["1","战役室","1628248856819"],"body":[["Unnamed433","E6B095A0D50DFE979613E886ADC7B723A1FCC457F46B0275D5B15B98593088A0","3","12","1","false","比赛中","1","35.263157","19","27.186.203.48:5123"]]},{"head":["1","战役室","1628248856819"],"body":[["Noname293922","8FE8E3FF4D50BC51A044AC3E2DACC1188EDAA82BDA3708EDDDB5283FB81DD420","2","281","0","false","比赛中","1","192.54546","11","115.178.225.121:5123"]]},{"head":["1","战役室","1628248856819"],"body":[["屯蛋小王子","17BA47E5A1AAB9F5BF94CE159464A0633CCFC4F06B1A3C3E9789509EE82FFC7C","6","40","0","false","比赛中","1","32.7","10","36.60.203.62:5123"]]},{"head":["1","战役室","1628248856819"],"body":[["Josué🇨🇺🇨🇺🇨🇺","A3D79F2859A04C17E0B34B59D92D7B00BBB7E05BDB72D751EAE6669A0B2E5085","0","388","0","false","比赛中","1","526.3333","3","152.206.232.46:5123"]]},{"head":["1","战役室","1628248856819"],"body":[["☃️青青艹原~雪王","5134B431C600A850F6363D933BB2C48AEEBDE05A9CF79EBC7C61762140BD3E9C","5","50","1","false","比赛中","1","50.0","0","221.192.180.142:5123"]]}]'
    function toCard(data,p,ys,ski){
        let hd=data[0]
        while(data.length>1){
            let c=data.pop()
            let a=g("div")
            a.classList.add("mc-ka-z","mc-dh")
            p.append(a)
            let h=g('div')
            h.classList.add("mc-ka-tou")
            a.append(h)
            for(let i in c.head){
                let h1=g("span")
                h1.innerText=c.head[i]
                if(i==2) h1.innerText=formatTime(new Date().getTime()-c.head[i])
                h.append(h1)
            }
            c.body.forEach(e=>{
                a.append(oneCard(e,hd,ski,ys))
            })
        }
    }
    function doPickCmd(v){
        if(pick.s==true){
            document.body.style.cursor="default";
            pick.s=false;
            msgSend(pick.for+" "+v);
            pick.for='';
            releaseBlock();
        }
    }
    function cmdList(data){
        let cmdList=data.substr(3)
        cmdList=cmdList.replaceAll("<","[")
        cmdList=cmdList.replaceAll(">","]")
        let cmdL = JSON.parse(cmdList);
        let cmdTab = document.getElementById("cmTab");
        cmdTab.innerText=""
        cmdL.forEach(x=>{
            let a = document.createElement("div");
            a.classList.add("cmdEl")
            let h = document.createElement("span");
            h.classList.add("btn")
            h.style.fontSize="15px"
            h.innerText=x.h
            let d = document.createElement("span");
            d.classList.add("des")
            d.innerText=x.d
            let p = document.createElement("span");
            p.classList.add("para")
            p.innerHTML=x.p
            cmdTab.append(a)
            a.append(h);a.append(d);a.append(p);
            if(x.p.length<1) {
                h.onclick=function (e){
                    e.stopPropagation();
                    let co=document.getElementById("b");
                    let c=document.getElementById("b").value;
                    co.value=x.h;
                    doCmd()
                    co.value=c;
                }
            }else{
                if(x.p.indexOf("PlayerSerialNumber")>-1){
                    d.onclick=function (e){
                        e.stopPropagation();
                        if(pick.s==true) return;
                        document.body.style.cursor="crosshair"
                        pick.s=true;
                        pick.for=x.h;
                        blockOther(document.querySelector("#playerTable > table"))
                    }
                }
                h.onclick=function (e){
                    e.stopPropagation();
                    document.getElementById("b").value=x.h
                }
            }
        })
    }
    function doCmd(){
        let ab=new Object()
        ab.a=document.getElementById("a").value;
        ab.b=document.getElementById("b").value;
        ws.send("-p"+ab.a+" -1 "+ab.b);
    }
    function drag0(obj){
        obj.onmousedown = function(e){
            if(e.target!=obj) return;
            if(obj.style.position!="fixed"&&obj.style.position!="absolute"){
                obj.rep=obj.style.position;
                let h=obj.offsetTop;
                let l=obj.offsetLeft;
                obj.style.position="absolute"
                obj.style.top=h+"px";
                obj.style.left=l+"px";
            }
            var divX = e.clientX - this.offsetLeft;
            var divY = e.clientY - this.offsetTop;
            document.onmousemove = function(e){
                var disX = e.clientX - divX;
                var disY = e.clientY - divY;
                obj.style.top = disY + "px";
                obj.style.left = disX + "px";
                document.onmouseup = function(e){
                    document.onmousedown = document.onmousemove = null;
                    if(e.pageY<20){obj.style.position=obj.rep;}
                }
            }
        }
    }
    drag0(document.getElementById("cmTab"))
    function sendServerMsg(){
        let pMsg = document.getElementById("pMsg").value;
        if(pMsg.length>0){
            msgSend("msg "+pMsg);
        }
    }
    setInterval(()=>{
        if(isCon)
        if(isGameStart)  playTimeDom.innerText= '游戏已开始:'+formatTime((new Date().getTime()-playStartTime))
        else playTimeDom.innerText="战役室:"+formatTime((new Date().getTime()-playStartTime))
    },1000)
    setInterval(()=>{
       if(isCon) {
          ws.send("-p1 -3 0")
       }
    },5000)
    function msgSend(m){
        let c=document.getElementById("b").value;
        document.getElementById("b").value=m;
        doCmd()
        document.getElementById("b").value=c;
    }

    function formatTime(t){
        let h=parseInt(t/(1000*60*60));
        return (0==h?"":h+"时")+parseInt(t/(1000*60)%60)+"分"+parseInt((t/1000)%60)+"秒"
    }
    //参数设置
    let serverCan=new Object()
    serverCan.show=true
    function getter(n){
        return serverCan.config[n];
    }
    function setter(n,v){
        msgSend("config "+n+" "+v)
        serverCan.config[n]=v
    }
    function flushAll(){
        msgSend("-sf"+JSON.stringify(serverCan.config))
    }

    function initServerCan(configString){
        let config=JSON.parse(configString.substring(4),(k,v)=>{
        if(v=="true") return true;
        if(v=="false") return false;
        if(v=="") return "";
        let vv=new Number(v);
        if(!isNaN(vv)) return vv;
        return v;
        })
        console.log(config)
        let miList=[]
        for(let i in config){
            if(config[i] instanceof Number) {
                miList.push([i,i,LX.prop,0,10000,1])
            }
            else if(typeof config[i] =="boolean") {
                miList.push([i,i,LX.bl])
            }else{
                miList.push([i,i,LX.wb])
            }
        }
        serverCan.miList=miList
        serverCan.config=config
        MiCan(miList,setter,getter,'服务器参数面板')
    }
    function setCan(){
        if(!serverCan.config){
            msgSend("-gf")
            setTimeout(() => {
                let start=new Date().getTime();
                while(!serverCan.config&&new Date().getTime()-start<10*1000){}
                if(new Date().getTime()-start>=10*1000) {
                    console.log("超时未响应")
                }
            }, 100);
        }else{
            if(serverCan.show) {xiaoshi(ban);serverCan.show=false}
            else {xianshi(ban);serverCan.show=true}
        }
    }
</script>
</body>
</html>